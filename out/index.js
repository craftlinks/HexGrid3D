var E={mu_k:4,sigma_k:1,w_k:0.022,mu_g:0.6,sigma_g:0.15,c_rep:1,dt:0.02,point_n:6400};async function S(){const b=await(await navigator.gpu?.requestAdapter())?.requestDevice();if(!b){fail("need a browser that supports WebGPU");return}else console.log("WebGPU is supported");var J=document.querySelector("canvas");const D=await fetch("./shaders/lenia_compute.wgsl").then((A)=>A.text()),W=b.createBuffer({label:"Rval buffer",size:E.point_n*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),X=b.createBuffer({label:"Uval buffer",size:E.point_n*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),Y=b.createBuffer({label:"Rgrad buffer",size:E.point_n*2*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),Z=b.createBuffer({label:"Ugrad buffer",size:E.point_n*2*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),K=b.createBuffer({label:"Position buffer",size:E.point_n*2*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),q=b.createBuffer({label:"Position buffer result",size:E.point_n*2*4,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});{const A=new Float32Array(E.point_n*2);for(let I=0;I<E.point_n;++I)A[I]=(Math.random()-0.5)*12,A[I+1]=(Math.random()-0.5)*12;b.queue.writeBuffer(K,0,A)}const M=b.createShaderModule({label:"Lenia Compute Shader",code:D}),N=b.createComputePipeline({label:"compute fields pipeline",layout:"auto",compute:{module:M,entryPoint:"compute_fields"}}),$=b.createComputePipeline({label:"update positions pipeline",layout:"auto",compute:{module:M,entryPoint:"update_positions"}}),O=b.createBindGroup({layout:N.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:W}},{binding:1,resource:{buffer:X}},{binding:2,resource:{buffer:Y}},{binding:3,resource:{buffer:Z}},{binding:4,resource:{buffer:K}}]});async function g(){const A=b.createCommandEncoder({label:"our command encoder"}),I=A.beginComputePass();I.setPipeline(N),I.setBindGroup(0,O),I.dispatchWorkgroups(E.point_n/64),I.end();const k=A.beginComputePass();k.setPipeline($),k.setBindGroup(0,O),k.dispatchWorkgroups(E.point_n/64),k.end(),A.copyBufferToBuffer(K,0,q,0,q.size);const H=A.finish();b.queue.submit([H])}async function y(A,I=100,k=10){for(let T=0;T<k;++T)await g();await q.mapAsync(GPUMapMode.READ);const H=new Float32Array(q.getMappedRange()),{width:L,height:Q}=A.canvas;A.resetTransform(),A.clearRect(0,0,L,Q),A.translate(L/2,Q/2);const V=L/I;A.scale(V,V),A.lineWidth=0.05;for(let T=0;T<E.point_n;++T){A.beginPath();const C=H[T*2],G=H[T*2+1];A.arc(C,G,0.075,0,Math.PI*2),A.stroke()}q.unmap()}const z=w();while(!0)await y(z),await new Promise(requestAnimationFrame)}var U=function(j){let b=window.devicePixelRatio||1,J=j.getBoundingClientRect();j.width=J.width*b,j.height=J.height*b;let D=j.getContext("2d");return D.scale(b,b),D},w=function(){return U(document.querySelector("canvas"))};S();
