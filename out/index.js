var E={mu_k:4,sigma_k:1,w_k:0.022,mu_g:0.6,sigma_g:0.15,c_rep:1,dt:0.02,point_n:6400};async function S(){const y=await(await navigator.gpu?.requestAdapter())?.requestDevice();if(!y){fail("need a browser that supports WebGPU");return}else console.log("WebGPU is supported");var G=document.querySelector("canvas");const D=await fetch("./shaders/lenia_compute.wgsl").then((b)=>b.text()),Q=y.createBuffer({label:"Rval buffer",size:E.point_n*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),T=y.createBuffer({label:"Uval buffer",size:E.point_n*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),U=y.createBuffer({label:"Rgrad buffer",size:E.point_n*2*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),V=y.createBuffer({label:"Ugrad buffer",size:E.point_n*2*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),H=y.createBuffer({label:"Position buffer",size:E.point_n*2*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),q=y.createBuffer({label:"Position buffer result",size:E.point_n*2*4,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});{const b=new Float32Array(E.point_n*2);for(let L=0;L<E.point_n;++L)b[L*2]=(Math.random()-0.5)*48,b[L*2+1]=(Math.random()-0.5)*48;y.queue.writeBuffer(H,0,b)}const I=y.createShaderModule({label:"Lenia Compute Shader",code:D}),W=y.createComputePipeline({label:"reset pipeline",layout:"auto",compute:{module:I,entryPoint:"reset_buffers"}}),K=y.createComputePipeline({label:"compute fields pipeline",layout:"auto",compute:{module:I,entryPoint:"compute_fields"}}),X=y.createComputePipeline({label:"update positions pipeline",layout:"auto",compute:{module:I,entryPoint:"update_positions"}}),J=y.createBindGroup({layout:K.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:Q}},{binding:1,resource:{buffer:T}},{binding:2,resource:{buffer:U}},{binding:3,resource:{buffer:V}},{binding:4,resource:{buffer:H}}]});async function Y(){const b=y.createCommandEncoder({label:"our command encoder"}),L=b.beginComputePass();L.setPipeline(W),L.setBindGroup(0,J),L.dispatchWorkgroups(E.point_n/64),L.end();const k=b.beginComputePass();k.setPipeline(K),k.setBindGroup(0,J),k.dispatchWorkgroups(E.point_n/64),k.end();const O=b.beginComputePass();O.setPipeline(X),O.setBindGroup(0,J),O.dispatchWorkgroups(E.point_n/64),O.end(),b.copyBufferToBuffer(H,0,q,0,q.size);const A=b.finish();y.queue.submit([A])}async function $(b,L=100,k=5){for(let Z=0;Z<k;++Z)await Y();await q.mapAsync(GPUMapMode.READ);const O=new Float32Array(q.getMappedRange()),{width:A,height:M}=b.canvas;b.resetTransform(),b.clearRect(0,0,A,M),b.translate(A/2,M/2);const N=A/L;b.scale(N,N),b.lineWidth=0.05;for(let Z=0;Z<E.point_n;++Z){b.beginPath();const C=O[Z*2],g=O[Z*2+1];b.arc(C,g,0.075,0,Math.PI*2),b.stroke()}q.unmap()}const z=P();while(!0)await $(z),await new Promise(requestAnimationFrame)}var F=function(j){let y=window.devicePixelRatio||1,G=j.getBoundingClientRect();j.width=G.width*y,j.height=G.height*y;let D=j.getContext("2d");return D.scale(y,y),D},P=function(){return F(document.querySelector("canvas"))};S();
